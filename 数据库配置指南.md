# TransGuyane 数据库配置指南

## 推荐方案：MongoDB Atlas（免费云数据库）

MongoDB Atlas 提供 **512MB 免费存储空间**，足够中小型应用使用。

---

## 一、MongoDB Atlas 配置步骤（图文指南）

### 步骤 1：注册账号

1. 访问 https://www.mongodb.com/atlas
2. 点击 **"Try Free"** 按钮
3. 使用 Google 账号或邮箱注册

### 步骤 2：创建免费集群

1. 登录后点击 **"Build a Database"**
2. 选择 **"FREE"** (M0 Sandbox) - 免费版
3. 选择云服务商和区域：
   - Provider: **AWS** 或 **Google Cloud**
   - Region: 选择最近的区域（推荐 **Hong Kong** 或 **Singapore**）
4. 点击 **"Create Cluster"**
5. 等待 1-3 分钟创建完成

### 步骤 3：创建数据库用户

1. 点击左侧菜单 **"Database Access"**
2. 点击 **"Add New Database User"**
3. 填写信息：
   - **Authentication Method**: Password
   - **Username**: `transguyane` （或自定义）
   - **Password**: 设置一个强密码（**不要包含特殊字符 @、:、/ 等**）
   - **Database User Privileges**: Atlas admin
4. 点击 **"Add User"**

### 步骤 4：配置网络访问（重要！）

1. 点击左侧菜单 **"Network Access"**
2. 点击 **"Add IP Address"**
3. 选择 **"Allow Access from Anywhere"**（允许 0.0.0.0/0）
   - 或者添加你的服务器 IP 地址
4. 点击 **"Confirm"**

### 步骤 5：获取连接字符串

1. 点击左侧菜单 **"Database"**
2. 点击集群的 **"Connect"** 按钮
3. 选择 **"Connect your application"**
4. 选择 Driver: **Node.js**, Version: **5.5 or later**
5. 复制连接字符串，类似：
   ```
   mongodb+srv://transguyane:<password>@cluster0.xxxxx.mongodb.net/?retryWrites=true&w=majority
   ```
6. 将 `<password>` 替换为你的实际密码
7. 在 `mongodb.net/` 后添加数据库名 `warehouse_management`

### 最终连接字符串格式

```
mongodb+srv://用户名:密码@cluster0.xxxxx.mongodb.net/warehouse_management?retryWrites=true&w=majority
```

---

## 二、快速配置方法

### 方法一：运行配置向导（推荐）

```
双击运行: 配置数据库.bat
```

按提示输入：
- 用户名
- 密码
- 集群地址（如 `cluster0.xxxxx.mongodb.net`）

### 方法二：手动配置

1. 编辑 `backend/.env` 文件：

```env
PORT=5000
MONGODB_URI=mongodb+srv://你的用户名:你的密码@cluster0.xxxxx.mongodb.net/warehouse_management?retryWrites=true&w=majority
JWT_SECRET=your_random_secret_key_here
```

2. 测试连接：

```bash
cd backend
npm install
node scripts/testConnection.js
```

---

## 三、常见问题

### Q1: 连接超时？

**原因**: 网络访问未配置

**解决**: 
1. 进入 MongoDB Atlas → Network Access
2. 添加 `0.0.0.0/0`（允许所有 IP）

### Q2: 认证失败？

**原因**: 密码包含特殊字符

**解决**: 
1. 密码不要包含 `@`、`:`、`/`、`%` 等特殊字符
2. 或者对密码进行 URL 编码

### Q3: 数据库不存在？

**原因**: 连接字符串缺少数据库名

**解决**: 确保连接字符串格式为：
```
mongodb+srv://user:pass@cluster.xxx.mongodb.net/warehouse_management?...
```
注意 `mongodb.net/` 后面要有 `warehouse_management`

### Q4: 连接字符串格式错误？

**正确格式示例**:
```
mongodb+srv://transguyane:MyPassword123@cluster0.abc123.mongodb.net/warehouse_management?retryWrites=true&w=majority
```

**错误示例**:
```
# 缺少数据库名
mongodb+srv://transguyane:MyPassword123@cluster0.abc123.mongodb.net/?retryWrites=true&w=majority

# 密码包含特殊字符未编码
mongodb+srv://transguyane:My@Pass:word@cluster0.abc123.mongodb.net/warehouse_management
```

---

## 四、验证配置

运行测试脚本：

```bash
cd backend
node scripts/testConnection.js
```

**成功输出**:
```
正在连接数据库...
连接字符串: mongodb+srv://transguyane:****@cluster0.xxx.mongodb.net/warehouse_management?...
[SUCCESS] MongoDB Atlas 连接成功！
数据库: warehouse_management
```

**失败输出**:
```
[ERROR] 连接失败: ...
```

---

## 五、其他数据库选项

### 阿里云 MongoDB

1. 购买阿里云 MongoDB 实例（约 ¥50-200/月）
2. 获取连接地址
3. 配置连接字符串：
```
mongodb://用户名:密码@地址:27017/warehouse_management?authSource=admin
```

### 本地 MongoDB

1. 安装 MongoDB Community Server
2. 启动服务
3. 配置连接字符串：
```
mongodb://localhost:27017/warehouse_management
```

---

## 六、配置完成后

1. **本地开发**: 运行 `一键部署.bat`
2. **云部署**: 将 `.env.production` 上传到服务器

---

**如有问题，请检查**:
1. MongoDB Atlas 网络访问设置
2. 用户名和密码是否正确
3. 连接字符串格式是否正确
