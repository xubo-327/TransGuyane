# TransGuyane 云部署指南

## 目录

1. [部署方式选择](#部署方式选择)
2. [方式一：Docker 一键部署（推荐）](#方式一docker-一键部署推荐)
3. [方式二：传统服务器部署](#方式二传统服务器部署)
4. [方式三：分离部署](#方式三分离部署)
5. [数据库配置](#数据库配置)
6. [域名与 HTTPS 配置](#域名与-https-配置)
7. [常见问题](#常见问题)

---

## 部署方式选择

| 方式 | 适合场景 | 难度 | 推荐度 |
|-----|---------|------|-------|
| Docker 部署 | 有 Docker 环境的云服务器 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 传统部署 | 直接在服务器运行 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 分离部署 | 前端 CDN + 后端服务器 | ⭐⭐⭐⭐ | ⭐⭐⭐ |

---

## 方式一：Docker 一键部署（推荐）

### 前置要求

- 云服务器（阿里云/腾讯云/AWS 等）
- 已安装 Docker 和 Docker Compose
- 开放端口：80, 443, 5000

### 步骤

#### 1. 安装 Docker（如未安装）

```bash
# CentOS/RHEL
curl -fsSL https://get.docker.com | sh
sudo systemctl start docker
sudo systemctl enable docker

# Ubuntu/Debian
curl -fsSL https://get.docker.com | sh
sudo systemctl start docker
sudo systemctl enable docker
```

#### 2. 上传项目文件

```bash
# 方式1：使用 Git
git clone https://your-repo-url.git transguyane
cd transguyane

# 方式2：使用 SCP 上传
scp -r ./货柜服务网站/* user@your-server:/home/user/transguyane/
```

#### 3. 配置环境变量

```bash
# 复制示例配置
cp .env.production.example .env.production

# 编辑配置
nano .env.production
```

**必须修改的配置：**

```env
# MongoDB Atlas 连接字符串
MONGODB_URI=mongodb+srv://用户名:密码@cluster.xxxxx.mongodb.net/warehouse_management?retryWrites=true&w=majority

# JWT 密钥（生成随机字符串）
JWT_SECRET=your_random_secret_key_here

# API 地址（替换为你的域名）
API_URL=https://yourdomain.com/api
```

#### 4. 一键部署

```bash
# 添加执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

选择选项 `1` 进行完整部署。

#### 5. 验证部署

```bash
# 查看容器状态
docker compose ps

# 查看日志
docker compose logs -f

# 测试 API
curl http://localhost:5000/api/health
```

### 常用命令

```bash
# 停止服务
docker compose down

# 重启服务
docker compose restart

# 查看日志
docker compose logs -f backend
docker compose logs -f frontend

# 进入容器
docker compose exec backend sh

# 更新部署
git pull
docker compose build --no-cache
docker compose up -d
```

---

## 方式二：传统服务器部署

### 前置要求

- Node.js 18+ 
- MongoDB 6.0+（或使用 MongoDB Atlas）
- Nginx
- PM2（Node.js 进程管理）

### 步骤

#### 1. 安装依赖

```bash
# 安装 Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 PM2
sudo npm install -g pm2

# 安装 Nginx
sudo apt-get install -y nginx
```

#### 2. 部署后端

```bash
cd backend

# 安装依赖
npm ci --only=production

# 创建环境变量文件
cp ../.env.production.example .env
nano .env  # 编辑配置

# 使用 PM2 启动
pm2 start ecosystem.config.js --env production

# 设置开机自启
pm2 save
pm2 startup
```

#### 3. 构建前端

```bash
cd frontend

# 安装依赖
npm ci --legacy-peer-deps

# 设置 API 地址
echo "REACT_APP_API_URL=/api" > .env.production

# 构建
npm run build

# 将构建产物复制到 Nginx 目录
sudo cp -r build/* /var/www/html/
```

#### 4. 配置 Nginx

```bash
sudo nano /etc/nginx/sites-available/transguyane
```

写入以下内容：

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # 前端
    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/transguyane /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 5. 创建管理员

```bash
cd backend
node scripts/createAdmin.js
```

---

## 方式三：分离部署

### 前端部署到 Vercel/Netlify

#### Vercel 部署

1. 访问 [vercel.com](https://vercel.com)
2. 导入 GitHub 仓库
3. 设置：
   - **Framework Preset**: Create React App
   - **Root Directory**: frontend
   - **Build Command**: `npm run build`
   - **Output Directory**: `build`
4. 添加环境变量：
   ```
   REACT_APP_API_URL=https://api.yourdomain.com/api
   ```
5. 点击 Deploy

#### Netlify 部署

1. 访问 [netlify.com](https://netlify.com)
2. 拖拽 `frontend/build` 文件夹到网页
3. 或连接 Git 仓库自动部署

### 后端部署到 Railway/Render

#### Railway 部署

1. 访问 [railway.app](https://railway.app)
2. 新建项目 → Deploy from GitHub
3. 选择仓库，设置 Root Directory 为 `backend`
4. 添加环境变量：
   ```
   MONGODB_URI=mongodb+srv://...
   JWT_SECRET=your_secret
   PORT=5000
   ```
5. 部署完成后获取 URL

#### Render 部署

1. 访问 [render.com](https://render.com)
2. 新建 Web Service
3. 连接 Git 仓库
4. 设置：
   - **Root Directory**: backend
   - **Build Command**: `npm install`
   - **Start Command**: `npm start`
5. 添加环境变量

---

## 数据库配置

### 推荐：MongoDB Atlas（免费云数据库）

1. 访问 [mongodb.com/atlas](https://www.mongodb.com/atlas)
2. 注册账号，创建免费集群
3. 设置数据库用户和密码
4. 配置网络访问（添加 `0.0.0.0/0` 允许所有 IP）
5. 获取连接字符串：
   ```
   mongodb+srv://用户名:密码@cluster0.xxxxx.mongodb.net/warehouse_management?retryWrites=true&w=majority
   ```

### 自建 MongoDB

```bash
# Docker 运行
docker run -d \
  --name mongodb \
  -p 27017:27017 \
  -v mongodb_data:/data/db \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=your_password \
  mongo:6.0
```

---

## 域名与 HTTPS 配置

### 使用 Let's Encrypt 免费 SSL

```bash
# 安装 Certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

### 配置 HTTPS（Nginx）

```nginx
server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # ... 其他配置
}

server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 常见问题

### Q: 部署后无法访问？

1. 检查防火墙端口是否开放（80, 443, 5000）
2. 检查云服务器安全组规则
3. 查看日志：`docker compose logs -f`

### Q: 数据库连接失败？

1. 检查 MongoDB Atlas IP 白名单
2. 验证连接字符串格式
3. 测试连接：`mongosh "your_connection_string"`

### Q: 前端 API 请求失败？

1. 检查 `REACT_APP_API_URL` 配置
2. 检查 Nginx 代理配置
3. 检查 CORS 设置

### Q: 如何更新部署？

```bash
# Docker 方式
git pull
docker compose build --no-cache
docker compose up -d

# 传统方式
git pull
cd backend && npm ci && pm2 restart all
cd ../frontend && npm ci && npm run build
sudo cp -r build/* /var/www/html/
```

### Q: 如何备份数据？

```bash
# 导出数据库
mongodump --uri="your_connection_string" --out=./backup

# 恢复数据库
mongorestore --uri="your_connection_string" ./backup
```

---

## 云服务商推荐

| 服务商 | 最低配置价格 | 推荐指数 |
|-------|------------|---------|
| 阿里云 ECS | ¥24/月起 | ⭐⭐⭐⭐⭐ |
| 腾讯云 CVM | ¥29/月起 | ⭐⭐⭐⭐⭐ |
| 华为云 ECS | ¥25/月起 | ⭐⭐⭐⭐ |
| AWS EC2 | $5/月起 | ⭐⭐⭐⭐ |
| Railway | 免费额度 | ⭐⭐⭐⭐ |
| Render | 免费额度 | ⭐⭐⭐⭐ |

---

**如有问题，请查看项目日志或提交 Issue。**
