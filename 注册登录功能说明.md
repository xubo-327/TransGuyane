# 注册和登录功能说明

## 功能概述

系统现在支持两种登录方式：
1. **账号密码登录/注册** - 传统方式，用户创建账户后使用用户名和密码登录
2. **微信一键登录** - 使用微信账号快速登录

## 后端API接口

### 1. 用户注册
- **接口：** `POST /api/auth/register`
- **请求体：**
```json
{
  "username": "用户名（必填，3-20个字符）",
  "password": "密码（必填，至少6个字符）",
  "nickname": "昵称（可选）",
  "email": "邮箱（可选）",
  "phone": "手机号（可选）"
}
```
- **响应：**
```json
{
  "token": "JWT Token",
  "user": {
    "id": "用户ID",
    "username": "用户名",
    "nickname": "昵称",
    "email": "邮箱",
    "phone": "手机号",
    "role": "user",
    "loginType": "account"
  }
}
```

### 2. 账号密码登录
- **接口：** `POST /api/auth/login`
- **请求体：**
```json
{
  "username": "用户名/邮箱/手机号",
  "password": "密码"
}
```
- **说明：** 支持使用用户名、邮箱或手机号登录
- **响应：** 同注册接口

### 3. 微信登录
- **接口：** `POST /api/auth/wechat`
- **请求体：**
```json
{
  "code": "微信授权码",
  "nickname": "昵称（可选）",
  "avatar": "头像（可选）"
}
```
- **开发模式：** 支持使用 `mock_code_` 开头的模拟code进行测试
- **响应：** 同注册接口

### 4. Token验证
- **接口：** `GET /api/auth/verify`
- **Headers：** `Authorization: Bearer {token}`
- **响应：** 返回用户信息

## 前端页面

### 1. 登录页面 (`/login`)
- **功能：**
  - 账号密码登录（默认）
  - 微信登录（标签页切换）
  - 链接到注册页面

### 2. 注册页面 (`/register`)
- **功能：**
  - 用户注册表单
  - 必填字段：用户名、密码
  - 可选字段：昵称、邮箱、手机号
  - 密码确认验证
  - 链接到登录页面

## 数据模型更新

### User 模型字段
- `username` - 用户名（唯一）
- `email` - 邮箱（唯一，可选）
- `phone` - 手机号（唯一，可选）
- `password` - 密码（加密存储）
- `openid` - 微信openid（微信登录用户）
- `nickname` - 昵称
- `avatar` - 头像URL
- `loginType` - 登录类型（'account' 或 'wechat'）
- `role` - 角色（'user' 或 'admin'）

## 安全性

1. **密码加密：** 使用 bcryptjs 进行密码哈希加密
2. **Token认证：** 使用 JWT Token 进行身份验证
3. **数据验证：** 使用 express-validator 进行输入验证
4. **唯一性约束：** 用户名、邮箱、手机号具有唯一性约束

## 开发模式

### 微信登录测试
在开发环境中，可以使用模拟code进行测试：
- Code格式：`mock_code_` + 时间戳
- 系统会自动识别并创建测试用户
- 每个mock code会生成唯一的openid

### 生产环境配置
在生产环境中，需要配置真实的微信AppID和Secret：
```env
WECHAT_APPID=your_real_appid
WECHAT_SECRET=your_real_secret
```

## 使用说明

### 用户注册流程
1. 访问 `/register` 页面
2. 填写用户名和密码（必填）
3. 可选填写昵称、邮箱、手机号
4. 点击注册按钮
5. 注册成功后自动登录并跳转到用户端首页

### 用户登录流程
1. 访问 `/login` 页面
2. 选择"账号登录"或"微信登录"
3. **账号登录：** 输入用户名/邮箱/手机号和密码
4. **微信登录：** 点击微信登录按钮（开发模式使用模拟code）
5. 登录成功后跳转到对应页面（用户端或管理端）

## 注意事项

1. **用户名规则：** 只能包含字母、数字和下划线，长度3-20个字符
2. **密码规则：** 至少6个字符
3. **邮箱格式：** 必须是有效的邮箱格式
4. **手机号格式：** 必须是11位中国大陆手机号
5. **唯一性：** 用户名、邮箱、手机号在系统中必须唯一

## 前后端一致性

✅ **已确保一致性：**
- API接口路径匹配
- 请求/响应数据结构一致
- 用户信息字段统一
- Token验证机制一致
- 错误处理格式统一

## 测试建议

1. 测试注册功能（正常情况、重复用户名等）
2. 测试账号登录（用户名、邮箱、手机号三种方式）
3. 测试微信登录（开发模式）
4. 测试Token验证
5. 测试权限控制（用户端/管理端）
